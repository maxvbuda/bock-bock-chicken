<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Homework Kanban Board</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f7f6f2;
      color: #333;
    }
    .top-menu {
      width: 100%;
      background: #fffbe7;
      border-bottom: 2px solid #e6d1a3;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .top-menu ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      gap: 24px;
    }
    .top-menu li {
      display: inline;
    }
    .top-menu a {
      display: inline-block;
      padding: 12px 28px;
      font-size: 1.1em;
      color: #fff;
      background: #d97428;
      border: none;
      border-radius: 8px;
      font-family: 'Georgia', serif;
      font-weight: bold;
      text-decoration: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    .top-menu a:hover {
      background: #a85c1a;
      color: #ffe4b3;
      text-decoration: none;
      box-shadow: 0 4px 16px rgba(0,0,0,0.13);
    }
    .top-menu a.active {
      background: #fffbe7;
      color: #d97428;
      border: 2px solid #d97428;
      cursor: default;
      box-shadow: none;
      pointer-events: none;
    }
    .kanban-board {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  gap: 2vw;
  row-gap: 0.2cm;
  margin: 48px auto 0 auto;
  max-width: 100vw;
  flex-wrap: nowrap;
  overflow-x: auto;
  padding: 0 2vw;
    }
    .kanban-column {
      background: #fffbe7;
      border: 2px solid #e6d1a3;
      border-radius: 16px;
  min-width: 250px;
  max-width: 400px;
  min-height: 700px;
  padding: 12px 6px 18px 6px;
  flex: 1 1 0;
    @media (max-width: 900px) {
      .kanban-board {
        gap: 1vw;
        padding: 0 1vw;
      }
      .kanban-column {
        min-width: 180px;
        max-width: 280px;
        min-height: 600px;
        padding: 8px 2px 12px 2px;
      }
    }
      box-shadow: 0 4px 16px rgba(0,0,0,0.07);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .kanban-column h2 {
      text-align: center;
      color: #d97428;
      font-family: 'Georgia', serif;
      font-size: 1.3em;
      margin: 0 0 12px 0;
    }
    .kanban-column h2 {
      text-align: center;
      color: #d97428;
      font-family: 'Georgia', serif;
      font-size: 1.3em;
      margin: 0 0 12px 0;
    }
    .kanban-tasks {
  flex: 1;
  min-height: 60px;
  position: relative;
  display: flex;
  flex-direction: column;
  gap: 0;
  margin-bottom: 2.2cm;
    }
    .kanban-task {
  background: url('images/egg.png') no-repeat center/cover;
  border-radius: 50% / 80%;
  padding: 48px 24px 56px 24px;
  font-size: 1em;
  color: #7a4a13;
  cursor: grab;
  border: none;
  transition: box-shadow 0.2s, background 0.2s;
  user-select: none;
  position: relative;
  min-height: 180px;
  min-width: 120px;
  max-width: 320px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  font-weight: bold;
  text-shadow: none;
  position: relative;
  overflow: hidden;
    }
    .kanban-task:not
      margin-top: -3.4cm;
    }
    .kanban-task.dragging {
      opacity: 0.5;
      background: #fffbe7;
      box-shadow: 0 4px 16px rgba(0,0,0,0.13);
    }
    .kanban-add-task {
  display: flex;
  gap: 8px;
  margin-top: 8px;
  width: 100%;
    }
    .kanban-add-task input {
  flex: 1 1 0;
  padding: 5px 6px;
  border-radius: 5px;
  border: 1px solid #e6d1a3;
  font-size: 0.95em;
  outline: none;
  min-width: 0;
  box-sizing: border-box;
    }
    .kanban-add-task button {
  background: #d97428;
  color: #fffbe7;
  border: none;
  border-radius: 5px;
  font-size: 0.95em;
  padding: 5px 10px;
  cursor: pointer;
  transition: background 0.2s;
  min-width: 0;
  box-sizing: border-box;
    @media (max-width: 900px) {
      .kanban-add-task input {
        font-size: 0.8em;
        padding: 3px 4px;
        border-radius: 4px;
      }
      .kanban-add-task button {
        font-size: 0.8em;
        padding: 3px 7px;
        border-radius: 4px;
      }
    }
    }
    .kanban-add-task button:hover {
      background: #a85c1a;
    }
  </style>
</head>
<body>
  <!-- Authentication check removed -->
  <nav class="top-menu">
    <ul>
      <li><a href="index.html">The Cluckington Family</a></li>
      <li><a href="family-members.html">Family Members</a></li>
      <li><a href="golden-knight.html">The Golden Knight of Chickenopolis</a></li>
      <li><a href="homework.html" class="active">Homework Kanban</a></li>
    </ul>
  </nav>
  <div id="add-column-container" style="text-align: center; padding: 20px 0; background: #f7f6f2;">
    <button id="add-column-btn" style="background: #5a9a5a; color: #fff; border: none; border-radius: 8px; font-size: 1.1em; padding: 10px 20px; cursor: pointer; transition: background 0.2s;">+ Add Column</button>
    <div id="add-column-form" style="display: none; gap: 8px; justify-content: center;">
      <input type="text" id="new-column-title" placeholder="Enter column name..." style="padding: 8px 12px; border-radius: 5px; border: 1px solid #e6d1a3; font-size: 1em;">
      <button id="save-column-btn" style="background: #5a9a5a; color: #fff; border: none; border-radius: 5px; padding: 8px 16px; cursor: pointer;">Save</button>
      <button id="cancel-add-column-btn" style="background: #d97428; color: #fff; border: none; border-radius: 5px; padding: 8px 12px; cursor: pointer;">Cancel</button>
    </div>
  </div>
  <div class="kanban-board" id="kanban-board">
    <!-- Columns will be dynamically inserted here -->
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let kanbanData = [];

      function saveKanban() {
        try {
          localStorage.setItem('kanban_homework_dynamic', JSON.stringify(kanbanData));
        } catch (e) {
          console.error("Error saving to localStorage", e);
        }
      }

      function loadKanban() {
        const data = localStorage.getItem('kanban_homework_dynamic');
        if (data) {
          try {
            kanbanData = JSON.parse(data);
            // Ensure data is an array
            if (!Array.isArray(kanbanData)) {
                throw new Error("Data is not an array");
            }
          } catch (e) {
            console.error("Error parsing kanban data, resetting.", e);
            initializeDefaultKanban();
          }
        } else {
            // Check for old data and migrate it
            const oldData = localStorage.getItem('kanban_homework');
            if(oldData) {
                try {
                    const parsedOldData = JSON.parse(oldData);
                    kanbanData = [
                        { title: "To Do", tasks: parsedOldData.todo || [] },
                        { title: "In Progress", tasks: parsedOldData.inprogress || [] },
                        { title: "Done", tasks: parsedOldData.done || [] }
                    ];
                    saveKanban(); // Save in new format
                    localStorage.removeItem('kanban_homework'); // Remove old data
                } catch (e) {
                    initializeDefaultKanban();
                }
            } else {
                initializeDefaultKanban();
            }
        }
      }
      
      function initializeDefaultKanban() {
        kanbanData = [
          { title: "To Do", tasks: ["Example task 1"] },
          { title: "In Progress", tasks: [] },
          { title: "Done", tasks: [] }
        ];
      }

      function renderKanban() {
        const board = document.getElementById('kanban-board');
        board.innerHTML = ''; // Clear the board

        kanbanData.forEach((column, columnIndex) => {
          const columnDiv = document.createElement('div');
          columnDiv.className = 'kanban-column';
          columnDiv.dataset.columnIndex = columnIndex;

          // Header with editable title and delete button
          const headerDiv = document.createElement('div');
          headerDiv.style.display = 'flex';
          headerDiv.style.justifyContent = 'space-between';
          headerDiv.style.alignItems = 'center';
          headerDiv.style.padding = '0 8px';

          const h2 = document.createElement('h2');
          h2.textContent = column.title;
          h2.contentEditable = true;
          h2.style.flexGrow = '1';
          h2.addEventListener('blur', () => {
            kanbanData[columnIndex].title = h2.textContent;
            saveKanban();
          });
          
          const deleteColBtn = document.createElement('button');
          deleteColBtn.textContent = '×';
          deleteColBtn.title = 'Delete Column';
          deleteColBtn.style.cssText = `background: #d97428; color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 1.2em; cursor: pointer; line-height: 1;`;
          deleteColBtn.onclick = () => deleteColumn(columnIndex);

          headerDiv.appendChild(h2);
          headerDiv.appendChild(deleteColBtn);
          columnDiv.appendChild(headerDiv);

          // Tasks container
          const tasksDiv = document.createElement('div');
          tasksDiv.className = 'kanban-tasks';
          tasksDiv.dataset.columnIndex = columnIndex;
          tasksDiv.addEventListener('dragover', onDragOver);
          tasksDiv.addEventListener('drop', onDrop);

          if (column.tasks) {
            column.tasks.forEach((taskText, taskIndex) => {
              tasksDiv.appendChild(createTaskElement(taskText, columnIndex, taskIndex));
            });
          }
          columnDiv.appendChild(tasksDiv);

          // Add task form
          const addTaskDiv = document.createElement('div');
          addTaskDiv.className = 'kanban-add-task';
          const input = document.createElement('input');
          input.type = 'text';
          input.placeholder = 'Add new homework...';
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              addTask(columnIndex, input.value);
              input.value = '';
            }
          });
          const button = document.createElement('button');
          button.textContent = 'Add';
          button.onclick = () => {
            addTask(columnIndex, input.value);
            input.value = '';
          };
          addTaskDiv.appendChild(input);
          addTaskDiv.appendChild(button);
          columnDiv.appendChild(addTaskDiv);

          board.appendChild(columnDiv);
        });
      }

      function createTaskElement(taskText, columnIndex, taskIndex) {
        const div = document.createElement('div');
        div.className = 'kanban-task';
        div.draggable = true;
        div.dataset.columnIndex = columnIndex;
        div.dataset.taskIndex = taskIndex;

        const textWrap = document.createElement('div');
        textWrap.style.cssText = `position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 60%; display: flex; align-items: center; justify-content: center; text-align: center; pointer-events: none;`;
        
        const span = document.createElement('span');
        span.textContent = taskText;
        span.style.cssText = `display: inline-block; word-break: break-word; font-size: 1em; color: #7a4a13; font-weight: bold;`;
        textWrap.appendChild(span);

        const delBtn = document.createElement('button');
        delBtn.textContent = '✖';
        delBtn.title = 'Delete Task';
        delBtn.style.cssText = `position: absolute; right: 0.2cm; top: 50%; transform: translateY(-50%); background: #ffe4b3; color: #a00; border: none; font-size: 1.1em; border-radius: 4px; cursor: pointer; padding: 2px 8px; pointer-events: auto; z-index: 3; box-shadow: 0 2px 8px rgba(0,0,0,0.07);`;
        delBtn.onclick = (e) => {
          e.stopPropagation();
          deleteTask(columnIndex, taskIndex);
        };

        div.appendChild(textWrap);
        div.appendChild(delBtn);
        div.addEventListener('dragstart', onDragStart);
        div.addEventListener('dragend', onDragEnd);
        return div;
      }

      function addTask(columnIndex, text) {
        const taskText = text.trim();
        if (!taskText) return;
        if (!kanbanData[columnIndex].tasks) {
          kanbanData[columnIndex].tasks = [];
        }
        kanbanData[columnIndex].tasks.push(taskText);
        saveKanban();
        renderKanban();
      }

      function deleteTask(columnIndex, taskIndex) {
        kanbanData[columnIndex].tasks.splice(taskIndex, 1);
        saveKanban();
        renderKanban();
      }

      function addColumn(title) {
        if (title) {
          kanbanData.push({ title: title, tasks: [] });
          saveKanban();
          renderKanban();
        }
      }

      function deleteColumn(columnIndex) {
        if (confirm(`Are you sure you want to delete the column "${kanbanData[columnIndex].title}"?`)) {
          kanbanData.splice(columnIndex, 1);
          saveKanban();
          renderKanban();
        }
      }

      document.getElementById('add-column-btn').addEventListener('click', () => {
        document.getElementById('add-column-btn').style.display = 'none';
        document.getElementById('add-column-form').style.display = 'flex';
        document.getElementById('new-column-title').focus();
      });

      document.getElementById('save-column-btn').addEventListener('click', () => {
        const newTitle = document.getElementById('new-column-title').value.trim();
        if (newTitle) {
          addColumn(newTitle);
          document.getElementById('new-column-title').value = '';
          document.getElementById('add-column-btn').style.display = 'block';
          document.getElementById('add-column-form').style.display = 'none';
        }
      });

      document.getElementById('cancel-add-column-btn').addEventListener('click', () => {
        document.getElementById('new-column-title').value = '';
        document.getElementById('add-column-btn').style.display = 'block';
        document.getElementById('add-column-form').style.display = 'none';
      });

      document.getElementById('new-column-title').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('save-column-btn').click();
        } else if (e.key === 'Escape') {
          document.getElementById('cancel-add-column-btn').click();
        }
      });

      // Drag and drop logic
      let dragSrc = null;

      function onDragStart(e) {
        dragSrc = {
          columnIndex: e.target.dataset.columnIndex,
          taskIndex: e.target.dataset.taskIndex
        };
        e.target.classList.add('dragging');
      }

      function onDragEnd(e) {
        e.target.classList.remove('dragging');
      }

      function onDragOver(e) {
        e.preventDefault();
      }

      function onDrop(e) {
        e.preventDefault();
        if (!dragSrc) return;

        const dropTarget = e.target.closest('.kanban-column');
        if (!dropTarget) return;

        const toColumnIndex = dropTarget.dataset.columnIndex;
        const fromColumnIndex = dragSrc.columnIndex;
        const fromTaskIndex = dragSrc.taskIndex;

        // Move task data
        const task = kanbanData[fromColumnIndex].tasks.splice(fromTaskIndex, 1)[0];
        if (!kanbanData[toColumnIndex].tasks) {
          kanbanData[toColumnIndex].tasks = [];
        }
        
        // Find drop position
        const dropTaskTarget = e.target.closest('.kanban-task');
        if(dropTaskTarget) {
            const toTaskIndex = dropTaskTarget.dataset.taskIndex;
            kanbanData[toColumnIndex].tasks.splice(toTaskIndex, 0, task);
        } else {
            kanbanData[toColumnIndex].tasks.push(task);
        }

        saveKanban();
        renderKanban();
        dragSrc = null;
      }

      // Initial load
      loadKanban();
      renderKanban();
    });
  </script>
  <!-- Logout Script -->
  <script>
    document.getElementById('logout-btn').addEventListener('click', function(e) {
      e.preventDefault();
      localStorage.removeItem('username');
      window.location.href = 'signin.html';
    });
  </script>
</body>
</html>
