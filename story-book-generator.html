<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chickenopolis Story Book Generator</title>
    
    <!-- PostHog Analytics -->
    <script>
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
        posthog.init('phc_sloVEwzIB8ds3BbJpYmgxRj36tofr4gVi4YcMnqikco',{api_host:'https://us.i.posthog.com'})
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- jsPDF Library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .title {
            font-size: 3em;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Quicksand', serif;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .subtitle {
            font-size: 1.2em;
            color: #b8d4ff;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffd700;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1em;
            box-sizing: border-box;
        }
        
        .generate-btn {
            width: 100%;
            padding: 16px;
            font-size: 1.2em;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #1a1a2e;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Quicksand', serif;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
        }
        
        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .progress {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .progress.active {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a1a2e;
            font-weight: 700;
        }
        
        .progress-text {
            text-align: center;
            color: #b8d4ff;
        }
        
        .stories-preview {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .story-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #ffd700;
        }
        
        .story-title {
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 8px;
        }
        
        .story-preview {
            color: #e8f4ff;
            font-size: 0.9em;
            white-space: pre-wrap;
            max-height: 200px;
            overflow: hidden;
        }
        
        .story-full {
            display: none;
        }
        
        .story-item.expanded .story-preview {
            display: none;
        }
        
        .story-item.expanded .story-full {
            display: block;
            color: #e8f4ff;
            font-size: 0.9em;
            white-space: pre-wrap;
        }
        
        .expand-btn {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 8px;
        }
        
        .expand-btn:hover {
            background: rgba(255, 215, 0, 0.3);
        }
        
        .download-section {
            text-align: center;
            margin-top: 30px;
        }
        
        .download-btn {
            padding: 16px 40px;
            font-size: 1.2em;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            font-family: 'Quicksand', serif;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
        }
        
        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="font-size: 80px;">üìöüêî</div>
            <h1 class="title">Chickenopolis Story Book Generator</h1>
            <p class="subtitle">Generate 100-1000 bedtime stories for your book!</p>
            <p class="subtitle" style="font-size: 0.9em; margin-top: 10px;">üíæ Auto-saves every 10 stories ‚Ä¢ Resume anytime!</p>
            <div id="saved-indicator" style="display: none; background: rgba(76, 175, 80, 0.2); border: 2px solid #4CAF50; border-radius: 10px; padding: 15px; margin-top: 15px; max-width: 500px; margin-left: auto; margin-right: auto;">
                <p style="color: #4CAF50; font-weight: 700; margin: 0; font-size: 1.1em;">
                    üíæ <span id="saved-count">0</span> stories saved in browser!
                </p>
                <p style="color: #b8d4ff; margin: 5px 0 0 0; font-size: 0.9em;">
                    Continue generating or download what you have
                </p>
            </div>
        </div>
        
        <div class="controls">
            <div class="input-group">
                <label for="book-title">Book Title</label>
                <input type="text" id="book-title" value="Tales from Chickenopolis" placeholder="Enter book title">
            </div>
            
            <div class="input-group">
                <label for="story-count">Number of Stories (10-1000)</label>
                <input type="number" id="story-count" value="50" min="10" max="1000">
            </div>
            
            <div class="input-group">
                <label for="story-length">Story Length</label>
                <select id="story-length">
                    <option value="short">Short (200-300 words = 1 page)</option>
                    <option value="medium" selected>Medium (350-450 words = 1.5 pages)</option>
                    <option value="long">Long (500-700 words = 2-3 pages)</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>
                    <input type="checkbox" id="auto-themes" checked> 
                    Auto-generate varied themes (adventure, friendship, bravery, etc.)
                </label>
            </div>
            
            <button class="generate-btn" id="generate-book-btn" onclick="generateBook()">
                üìö Generate Story Book
            </button>
            
            <button class="generate-btn" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); margin-top: 15px;" onclick="clearProgress()">
                üóëÔ∏è Clear Saved Progress
            </button>
        </div>
        
        <div class="progress" id="progress-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill">0%</div>
            </div>
            <div class="progress-text" id="progress-text">Generating stories...</div>
        </div>
        
        <div class="stories-preview" id="stories-preview" style="display: none;">
            <h2 style="color: #ffd700; margin-bottom: 20px;">Generated Stories</h2>
            <div id="stories-list"></div>
        </div>
        
        <div class="download-section" id="download-section" style="display: none;">
            <h2 style="color: #ffd700; margin-bottom: 20px;">Your book is ready!</h2>
            <p id="book-stats" style="color: #b8d4ff; margin-bottom: 20px;"></p>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 15px;">
                <button class="download-btn" onclick="downloadAsText()">üìÑ TXT</button>
                <button class="download-btn" onclick="downloadAsPDF()">üìï PDF</button>
                <button class="download-btn" onclick="downloadAsHTML()">üåê HTML</button>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 15px;">
                <button class="download-btn" onclick="downloadAsMarkdown()">üìù Markdown</button>
                <button class="download-btn" onclick="downloadAsJSON()">üìä JSON</button>
                <button class="download-btn" onclick="downloadAsCSV()">üìà CSV</button>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                <button class="download-btn" onclick="downloadAllFormats()">üíæ Download ALL (7 formats)</button>
            </div>
            <p style="color: #b8d4ff; margin-top: 15px; font-size: 0.9em;">
                ‚ö° PDF generation may take a minute for large books
            </p>
        </div>
    </div>
    
    <script>
        let generatedStories = [];
        const SAVE_INTERVAL = 10; // Save every 10 stories
        
        // Load saved progress on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadProgress();
        });
        
        function saveProgress() {
            try {
                localStorage.setItem('chickenopolis_stories', JSON.stringify(generatedStories));
                localStorage.setItem('chickenopolis_book_title', document.getElementById('book-title').value);
                console.log('Progress saved:', generatedStories.length, 'stories');
            } catch (e) {
                console.error('Failed to save progress:', e);
            }
        }
        
        function loadProgress() {
            try {
                const saved = localStorage.getItem('chickenopolis_stories');
                if (saved) {
                    generatedStories = JSON.parse(saved);
                    if (generatedStories.length > 0) {
                        // Show saved indicator
                        document.getElementById('saved-indicator').style.display = 'block';
                        document.getElementById('saved-count').textContent = generatedStories.length;
                        
                        document.getElementById('stories-preview').style.display = 'block';
                        document.getElementById('download-section').style.display = 'block';
                        
                        // Restore preview
                        generatedStories.forEach(item => {
                            addStoryToPreview(item.number, item.theme, item.story);
                        });
                        
                        // Update stats
                        const totalWords = generatedStories.reduce((sum, s) => sum + s.story.split(' ').length, 0);
                        const estimatedPages = Math.round(totalWords / 250);
                        document.getElementById('book-stats').textContent = 
                            `${generatedStories.length} stories | ~${totalWords.toLocaleString()} words | ~${estimatedPages.toLocaleString()} pages`;
                    }
                }
                
                const savedTitle = localStorage.getItem('chickenopolis_book_title');
                if (savedTitle) {
                    document.getElementById('book-title').value = savedTitle;
                }
            } catch (e) {
                console.error('Failed to load progress:', e);
            }
        }
        
        function clearProgress() {
            if (confirm('Are you sure you want to clear all saved stories and start fresh?')) {
                localStorage.removeItem('chickenopolis_stories');
                localStorage.removeItem('chickenopolis_book_title');
                generatedStories = [];
                document.getElementById('stories-list').innerHTML = '';
                document.getElementById('stories-preview').style.display = 'none';
                document.getElementById('download-section').style.display = 'none';
                document.getElementById('saved-indicator').style.display = 'none';
                alert('‚úÖ Progress cleared!');
            }
        }
        
        const themes = [
            'brave knight rescuing the kingdom',
            'magical forest adventure',
            'space exploration',
            'underwater treasure hunt',
            'friendly dragons and castles',
            'solving mysteries',
            'learning to fly',
            'making new friends',
            'overcoming fears',
            'helping others',
            'discovering hidden talents',
            'teamwork and cooperation',
            'being kind to everyone',
            'learning patience',
            'finding courage',
            'protecting the family',
            'exploring new places',
            'music and dancing',
            'building something amazing',
            'racing and competitions'
        ];
        
        const morals = [
            'kindness', 'bravery', 'friendship', 'honesty', 'patience', 
            'courage', 'teamwork', 'perseverance', 'compassion', 'loyalty',
            'generosity', 'respect', 'determination', 'forgiveness', 'gratitude'
        ];
        
        async function generateBook() {
            const storyCount = parseInt(document.getElementById('story-count').value);
            const bookTitle = document.getElementById('book-title').value;
            const storyLength = document.getElementById('story-length').value;
            const autoThemes = document.getElementById('auto-themes').checked;
            
            if (storyCount < 10 || storyCount > 1000) {
                alert('Please enter a number between 10 and 1000');
                return;
            }
            
            generatedStories = [];
            document.getElementById('generate-book-btn').disabled = true;
            document.getElementById('progress-section').classList.add('active');
            document.getElementById('stories-preview').style.display = 'block';
            document.getElementById('download-section').style.display = 'none';
            document.getElementById('stories-list').innerHTML = '';
            
            for (let i = 0; i < storyCount; i++) {
                const theme = autoThemes ? themes[Math.floor(Math.random() * themes.length)] : 'adventure in Chickenopolis';
                const moral = morals[Math.floor(Math.random() * morals.length)];
                const childName = ''; // Leave blank for variety
                
                try {
                    const story = await generateSingleStory(childName, theme, storyLength, moral);
                    generatedStories.push({
                        number: i + 1,
                        theme: theme,
                        story: story
                    });
                    
                    // Update progress
                    const progress = Math.round(((i + 1) / storyCount) * 100);
                    document.getElementById('progress-fill').style.width = progress + '%';
                    document.getElementById('progress-fill').textContent = progress + '%';
                    document.getElementById('progress-text').textContent = `Generated ${i + 1} of ${storyCount} stories...`;
                    
                    // Add to preview
                    addStoryToPreview(i + 1, theme, story);
                    
                    // Auto-save every 10 stories
                    if ((i + 1) % SAVE_INTERVAL === 0) {
                        saveProgress();
                        document.getElementById('progress-text').textContent = 
                            `Generated ${i + 1} of ${storyCount} stories... ‚úÖ Auto-saved!`;
                    }
                    
                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                } catch (error) {
                    console.error('Error generating story', i + 1, error);
                    document.getElementById('progress-text').textContent = `Error on story ${i + 1}. Retrying...`;
                    i--; // Retry this story
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
            
            // Final save at the end
            saveProgress();
            document.getElementById('progress-text').textContent = '‚úÖ All stories generated and saved!';
            document.getElementById('generate-book-btn').disabled = false;
            document.getElementById('download-section').style.display = 'block';
            
            // Calculate stats
            const totalWords = generatedStories.reduce((sum, s) => sum + s.story.split(' ').length, 0);
            const estimatedPages = Math.round(totalWords / 250); // ~250 words per page
            document.getElementById('book-stats').textContent = 
                `${storyCount} stories | ~${totalWords.toLocaleString()} words | ~${estimatedPages.toLocaleString()} pages`;
        }
        
        async function generateSingleStory(childName, theme, length, moral) {
            let wordCount;
            if (length === 'short') wordCount = '200-300';
            else if (length === 'long') wordCount = '500-700';
            else wordCount = '350-450';
            
            const prompt = `üêîüêîüêî ABSOLUTE CRITICAL REQUIREMENT: You MUST write this story ENTIRELY about CHICKENS in CHICKENOPOLIS! üêîüêîüêî

Write a gentle, calming bedtime story for children aged 5-8 years old.

üö®üö®üö® MANDATORY CHICKENOPOLIS RULES - YOU MUST FOLLOW THESE: üö®üö®üö®
1. The ENTIRE story takes place in Chickenopolis (a magical chicken kingdom)
2. EVERY SINGLE CHARACTER is a chicken (rooster, hen, or chick) - NO HUMANS! NO OTHER ANIMALS! ONLY CHICKENS!
3. Main character: ${childName ? `A young chicken named ${childName}` : 'A brave young chicken from the Cluckington family'} who lives in Chickenopolis
4. You MUST include characters from the famous Cluckington family:
   - Mother Henrietta Cluckington (famous for her delicious corn muffins that last forever)
   - Father Roostwell Cluckington (brave protector who crows at dawn, defends from foxes)
   - Peep (youngest chick, curious, dreams of adventure, quick thinking, big heart, master at hide-and-seek) 
   - Sir Peepius Aurelius (grown-up Peep - the legendary Golden Knight who wears golden armor, carries a tiny sword, speaks heroically with phrases like "Hark!" and "Verily!", protector of all Chickenopolis from foxes and dangers, brave and chivalrous)
   - Cheepers (musical chick, always singing and making up silly songs, leads dance parties)
   - Nugget (boldest chick, endless energy, climbs haystacks, races through fields, dreams of being explorer)
   - Professor Featherbeak (wise old chicken who gives riddles and counsel)
5. Characters MUST cluck, peck, scratch ground, flap wings, ruffle feathers
6. Story Theme: ${theme} (but done with CHICKENS in CHICKENOPOLIS!)
7. Story Length: ${wordCount} words
8. Moral/Lesson: ${moral} (taught through chicken experiences in Chickenopolis)

üêî REQUIRED CHICKENOPOLIS ELEMENTS (You MUST include at least 5 of these):
- The Great Coop (the royal palace where King Clucksworth rules)
- Feather Plaza (the bustling town square where chickens gather)
- Egg Market (where chickens trade golden eggs and grain)
- Golden Grain Fields (the farmland surrounding Chickenopolis)
- The Roost Library (where wise chickens keep knowledge)
- Cluck Cathedral (the spiritual center with beautiful perches)
- Nest Park (playground where chicks play and learn to fly)
- Perch Academy (the school for young chicks)

STORY REQUIREMENTS:
- Start with "In the magical kingdom of Chickenopolis..."
- Every character name MUST sound like a chicken name
- Include chicken sounds and behaviors in EVERY paragraph
- Calming and peaceful, perfect for bedtime
- Simple, gentle language appropriate for 5-8 year-olds
- Happy ending where the chicken returns to their cozy coop and settles into a soft nest
- End with the main character yawning, closing their eyes, and drifting to peaceful sleep

üö® FINAL WARNING: If ANY character is not a chicken, or if the story is not OBVIOUSLY set in Chickenopolis with chicken details throughout, you have COMPLETELY FAILED! üö®`;
            
            const response = await fetch('https://bock-bock-chicken.onrender.com/api/generate-story', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': 'bs_11afe5bbc0142701392a9a5b71c559072923c68fbf2f3000'
                },
                body: JSON.stringify({ prompt: prompt })
            });
            
            const data = await response.json();
            if (!response.ok || !data.success) {
                throw new Error(data.message || 'Failed to generate story');
            }
            
            return data.story;
        }
        
        function addStoryToPreview(number, theme, story) {
            const storiesList = document.getElementById('stories-list');
            const storyItem = document.createElement('div');
            storyItem.className = 'story-item';
            storyItem.innerHTML = `
                <div class="story-title">Story ${number}: ${theme}</div>
                <div class="story-preview">${story.substring(0, 300)}...</div>
                <div class="story-full">${story}</div>
                <button class="expand-btn" onclick="toggleStory(this)">üìñ Read Full Story</button>
            `;
            storiesList.appendChild(storyItem);
            storiesList.scrollTop = storiesList.scrollHeight;
        }
        
        function toggleStory(btn) {
            const storyItem = btn.closest('.story-item');
            storyItem.classList.toggle('expanded');
            btn.textContent = storyItem.classList.contains('expanded') ? 'üìï Show Preview' : 'üìñ Read Full Story';
        }
        
        function downloadAsText() {
            const bookTitle = document.getElementById('book-title').value;
            let content = `${bookTitle}\n`;
            content += `${'='.repeat(bookTitle.length)}\n\n`;
            content += `A Collection of ${generatedStories.length} Bedtime Stories from Chickenopolis\n\n`;
            content += `${'='.repeat(60)}\n\n`;
            
            generatedStories.forEach((item, index) => {
                content += `\n\nSTORY ${item.number}\n`;
                content += `Theme: ${item.theme}\n`;
                content += `${'-'.repeat(60)}\n\n`;
                content += item.story;
                content += `\n\n${'-'.repeat(60)}\n`;
            });
            
            downloadFile(content, `${bookTitle.replace(/[^a-z0-9]/gi, '_')}.txt`, 'text/plain');
        }
        
        function downloadAsHTML() {
            const bookTitle = document.getElementById('book-title').value;
            let html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${bookTitle}</title>
    <style>
        body { font-family: 'Georgia', serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.8; background: #fffef9; color: #333; }
        h1 { color: #d97428; text-align: center; font-size: 2.5em; margin-bottom: 10px; }
        h2 { color: #d97428; border-bottom: 3px solid #ffd700; padding-bottom: 10px; margin-top: 50px; }
        .story { background: white; padding: 30px; border-radius: 10px; margin: 30px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .story-title { color: #d97428; font-size: 1.5em; font-weight: bold; margin-bottom: 15px; }
        .theme { color: #888; font-style: italic; margin-bottom: 20px; }
        .story-content { white-space: pre-wrap; }
        @media print { body { margin: 0; } .story { page-break-inside: avoid; } }
    </style>
</head>
<body>
    <h1>${bookTitle}</h1>
    <p style="text-align: center; color: #888;">A Collection of ${generatedStories.length} Bedtime Stories from Chickenopolis</p>
    <hr style="border: 2px solid #ffd700; margin: 30px 0;">
`;
            
            generatedStories.forEach((item) => {
                html += `
    <div class="story">
        <div class="story-title">Story ${item.number}</div>
        <div class="theme">Theme: ${item.theme}</div>
        <div class="story-content">${item.story}</div>
    </div>
`;
            });
            
            html += `
</body>
</html>`;
            
            downloadFile(html, `${bookTitle.replace(/[^a-z0-9]/gi, '_')}.html`, 'text/html');
        }
        
        function downloadAsMarkdown() {
            const bookTitle = document.getElementById('book-title').value;
            let content = `# ${bookTitle}\n\n`;
            content += `*A Collection of ${generatedStories.length} Bedtime Stories from Chickenopolis*\n\n`;
            content += `---\n\n`;
            
            generatedStories.forEach((item) => {
                content += `## Story ${item.number}: ${item.theme}\n\n`;
                content += `${item.story}\n\n`;
                content += `---\n\n`;
            });
            
            downloadFile(content, `${bookTitle.replace(/[^a-z0-9]/gi, '_')}.md`, 'text/markdown');
        }
        
        function downloadAsJSON() {
            const bookTitle = document.getElementById('book-title').value;
            const data = {
                title: bookTitle,
                totalStories: generatedStories.length,
                generatedDate: new Date().toISOString(),
                stories: generatedStories
            };
            
            downloadFile(JSON.stringify(data, null, 2), `${bookTitle.replace(/[^a-z0-9]/gi, '_')}.json`, 'application/json');
        }
        
        function downloadAsCSV() {
            const bookTitle = document.getElementById('book-title').value;
            let csv = 'Story Number,Theme,Story Content\n';
            
            generatedStories.forEach((item) => {
                // Escape quotes and wrap in quotes for CSV
                const story = '"' + item.story.replace(/"/g, '""') + '"';
                const theme = '"' + item.theme.replace(/"/g, '""') + '"';
                csv += `${item.number},${theme},${story}\n`;
            });
            
            downloadFile(csv, `${bookTitle.replace(/[^a-z0-9]/gi, '_')}.csv`, 'text/csv');
        }
        
        function downloadAllFormats() {
            if (confirm('This will download your book in 6 different formats (TXT, PDF, HTML, Markdown, JSON, CSV). Continue?')) {
                downloadAsText();
                setTimeout(() => downloadAsHTML(), 300);
                setTimeout(() => downloadAsPDF(), 600);
                setTimeout(() => downloadAsMarkdown(), 1000);
                setTimeout(() => downloadAsJSON(), 1300);
                setTimeout(() => downloadAsCSV(), 1600);
                setTimeout(() => {
                    alert('‚úÖ All 6 formats downloaded!');
                }, 2000);
            }
        }
        
        function downloadAsPDF() {
            const bookTitle = document.getElementById('book-title').value;
            
            // Show loading message
            const originalBtn = event.target;
            const originalText = originalBtn.textContent;
            originalBtn.disabled = true;
            originalBtn.textContent = '‚è≥ Generating PDF...';
            
            setTimeout(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 20;
                    const maxWidth = pageWidth - (margin * 2);
                    let yPosition = margin;
                    
                    // Title page
                    doc.setFontSize(24);
                    doc.setTextColor(217, 116, 40);
                    doc.text(bookTitle, pageWidth / 2, yPosition, { align: 'center' });
                    
                    yPosition += 15;
                    doc.setFontSize(12);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`A Collection of ${generatedStories.length} Bedtime Stories from Chickenopolis`, pageWidth / 2, yPosition, { align: 'center' });
                    
                    yPosition += 10;
                    doc.setLineWidth(0.5);
                    doc.setDrawColor(255, 215, 0);
                    doc.line(margin, yPosition, pageWidth - margin, yPosition);
                    
                    // Add stories
                    generatedStories.forEach((item, index) => {
                        // Add new page for each story (except first)
                        if (index > 0) {
                            doc.addPage();
                            yPosition = margin;
                        } else {
                            yPosition += 20;
                        }
                        
                        // Story title
                        doc.setFontSize(16);
                        doc.setTextColor(217, 116, 40);
                        const title = `Story ${item.number}`;
                        doc.text(title, margin, yPosition);
                        yPosition += 7;
                        
                        // Theme
                        doc.setFontSize(10);
                        doc.setTextColor(150, 150, 150);
                        doc.text(`Theme: ${item.theme}`, margin, yPosition);
                        yPosition += 10;
                        
                        // Story content
                        doc.setFontSize(11);
                        doc.setTextColor(50, 50, 50);
                        const lines = doc.splitTextToSize(item.story, maxWidth);
                        
                        lines.forEach((line) => {
                            if (yPosition > pageHeight - margin) {
                                doc.addPage();
                                yPosition = margin;
                            }
                            doc.text(line, margin, yPosition);
                            yPosition += 6;
                        });
                    });
                    
                    // Save PDF
                    doc.save(`${bookTitle.replace(/[^a-z0-9]/gi, '_')}.pdf`);
                    
                    originalBtn.disabled = false;
                    originalBtn.textContent = originalText;
                    
                } catch (error) {
                    console.error('PDF generation error:', error);
                    alert('PDF generation failed. Try downloading as HTML instead and print to PDF from your browser.');
                    originalBtn.disabled = false;
                    originalBtn.textContent = originalText;
                }
            }, 100);
        }
        
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function downloadAsPDF() {
            alert('PDF generation coming soon! For now, download as TXT and convert using a PDF tool, or copy-paste into Microsoft Word/Google Docs and save as PDF.');
        }
    </script>
</body>
</html>